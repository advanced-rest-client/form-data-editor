<!doctype html>
<!--
@license
Copyright 2017 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>
    <link rel="import" href="../form-data-editor.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <form-data-editor></form-data-editor>
      </template>
    </test-fixture>

    <script>
    /* global fixture, assert, TestHelpers, MockInteractions */
    /* jshint esnext:true */
    suite('basic', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      test('model is undefined', function() {
        assert.isUndefined(element.model);
      });

      test('value is undefined', function() {
        assert.isUndefined(element.value);
      });

      test('generated the model', function() {
        element.value = 'x-test=x-value';
        assert.typeOf(element.model, 'array');
      });

      test('model has valid properties', function() {
        element.value = 'x-test=x-value';
        var compare = {
          name: 'x-test',
          value: 'x-value'
        };
        assert.deepEqual(element.model[0], compare);
      });

      test('change in model generates the value', function() {
        element.value = 'x-test=x-value';
        element.set(['model', 0, 'value'], 'x-value-test');
        assert.equal(element.value, 'x-test=x-value-test');
      });

      test('decodes value', function() {
        element.value = 'x+test=x+value';
        element._decodePaylod();

        assert.equal(element.value, 'x test=x value');
      });
    });

    suite('add()', function() {
      var element;
      setup(function() {
        element = fixture('basic');
      });

      test('Adds item to model', function() {
        element.add();
        assert.lengthOf(element.model, 1);
      });

      test('Added item has empty value', function() {
        element.add();
        assert.equal(element.model[0].value, '');
      });

      test('Added item has empty name', function() {
        element.add();
        assert.equal(element.model[0].name, '');
      });

      test('Added item has predefined values', function() {
        element.add({
          name: 'test-name',
          value: 'test-value'
        });
        assert.equal(element.model[0].name, 'test-name', 'name equals test-name');
        assert.equal(element.model[0].value, 'test-value', 'value equals test-value');
      });
    });

    suite('_encodePaylod()', function() {
      var element;
      const TEST_VALUE = 'x test=x value';

      setup(function() {
        element = fixture('basic');
        element.value = TEST_VALUE;
        element._encodePaylod();
      });

      test('Encodes value', function() {
        assert.equal(element.value, 'x+test=x+value');
      });

      test('Encodes model value', function() {
        assert.equal(element.model[0].value, 'x+value');
      });

      test('Encodes model value name', function() {
        assert.equal(element.model[0].name, 'x+test');
      });
    });

    suite('_decodePaylod()', function() {
      var element;
      const TEST_VALUE = 'x+test=x+value';

      setup(function() {
        element = fixture('basic');
        element.value = TEST_VALUE;
        element._decodePaylod();
      });

      test('Decodes value', function() {
        assert.equal(element.value, 'x test=x value');
      });

      test('Decodes model value', function() {
        assert.equal(element.model[0].value, 'x value');
      });

      test('Decodes model value name', function() {
        assert.equal(element.model[0].name, 'x test');
      });
    });

    suite('updateModel()', function() {
      var element;
      const TEST_VALUE = 'x+test=x+value&param=value';

      setup(function() {
        element = fixture('basic');
        element.updateModel(TEST_VALUE);
      });

      test('Creates model array', function() {
        assert.typeOf(element.model, 'array');
      });

      test('Model has 2 items', function() {
        assert.lengthOf(element.model, 2);
      });

      test('Generates items in order', function() {
        assert.equal(element.model[0].name, 'x+test');
        assert.equal(element.model[1].name, 'param');
      });

      test('Model has valid values', function() {
        assert.equal(element.model[0].value, 'x+value');
        assert.equal(element.model[1].value, 'value');
      });
    });

    suite('_createModelItem()', function() {
      var element;

      setup(function() {
        element = fixture('basic');
      });

      test('Creates item with default values', function() {
        var model = element._createModelItem();
        assert.equal(model.name, '');
        assert.equal(model.value, '');
        assert.typeOf(model.model, 'object');
      });

      test('Creates item with predefined values', function() {
        var model = element._createModelItem({
          name: 'test-name',
          value: 'test-value'
        });
        assert.equal(model.name, 'test-name');
        assert.equal(model.value, 'test-value');
      });
    });

    suite('_removeParam()', function() {
      var element;

      setup(function() {
        element = fixture('basic');
        element.value = 'x+test=x+value';
        TestHelpers.forceXIfStamp(element);
      });

      function getFormItem() {
        return Polymer.dom(element.root)
          .querySelector('#form .form-item:last-of-type paper-icon-button');
      }

      test('UI removes item from the model', function() {
        var button = getFormItem();
        MockInteractions.tap(button);
        assert.lengthOf(element.model, 0);
        assert.equal(element.value, '');
      });

      test('Function removes item from the model', function() {
        var button = getFormItem();
        element._removeParam({
          target: button
        });
        assert.lengthOf(element.model, 0);
        assert.equal(element.value, '');
      });
    });
    </script>

  </body>
</html>
