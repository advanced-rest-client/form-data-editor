<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../arc-icons/arc-icons.html">
<link rel="import" href="../arc-polyfills/arc-polyfills.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../request-payload-editor-behavior/request-payload-editor-behavior.html">
<link rel="import" href="../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../raml-type-form-behavior/raml-type-form-behavior.html">
<link rel="import" href="form-data-editor-item.html">
<!--
An element to edit form data (x-www-form-urlencoded).

The element renders a form of body properties. Each row contains name and value input fields to
describe parameters in body.
Empty values for both name and value inputs are not included in final body value.

### Example

```
<form-data-editor></form-data-editor>
```

The element contains encode and decode values buttons so the user can choose if and when to
decode / encode the value. If `autoEncode` property is set (the `auto-encode` attribute) then this
task will be handled automatically. However it may cause problems for the user in some cases (when,
for example the user paste already encoded value to the input field it will be encoded again).

### Example

```html
<form-data-editor auto-encode value="{{payload}}"></form-data-editor>
```

### Prohibit element from computing values

The element will compute it's internal model every time the value change. Sometimes you may want to
use this element alongside other payload editors. In this case, if the element is still in the DOM
and accepts value change, you may wish to prohibit any computations if other element is handling
payload edits. To do so, set `attrForOpened` property to an attribute name that will be set when
the element should process inputs. If this attribute is not set, then computations will be halted.

Value for `attrForOpened` can be any name that is not already used by the element in the properties
list.

### Example

```html
<form-data-editor attr-for-opened="enabled"></form-data-editor>

<script>
  function enableEditor() {
    document.querySelector('form-data-editor').setAttribute('enabled', true);
  }
</script>
```

Note, it will only work if you set an attribute. It will not handle property change.

### Styling
`<form-data-editor>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--form-data-editor` | Mixin applied to the element | `{}`
`--form-data-editor-row` | Mixin applied to form rows | `{}`
`--form-data-editor-name-input` | Mixin applied to name input container | `{}`
`--form-data-editor-value-input` | Mixin applied to value input container | `{}`
`--form-data-editor-encode-buttons` | Mixin applied to encode / decode buttons container | `{}`
`--action-button` | Theme mixin, applied to the "add parameter" button | `{}`
`--form-data-editor-add-button` | Mixin applied to the "add parameter" button | `{}`
`--form-data-editor-add-button-background-color` | Background color of the "add parameter" button | `--primary-color`
`--form-data-editor-add-button-color` | Font color of the "add parameter" button | `--primary-background-color`
`--from-row-action-icon-color` | Delete parameter button color | `--icon-button-color` or `rgba(0, 0, 0, 0.74)`
`--from-row-action-icon-color-hover` | Delete parameter button color when hovering with the pointer | `--accent-color` or `rgba(0, 0, 0, 0.74)`

@group UI Elements
@element form-data-editor
@demo demo/index.html
-->
<dom-module id="form-data-editor">
  <template>
    <style>
    :host {
      display: block;
    }

    .form-row {
      @apply(--layout-horizontal);
      @apply(--layout-center);

      @apply(--form-data-editor-row);
    }

    form-data-editor-item {
      @apply(--layout-flex);
    }

    .encoder-buttons {
      margin: 8px 0;
      @apply(--form-data-editor-encode-buttons);
    }

    .add-param-button {
      margin-top: 12px;
      background-color: var(--form-data-editor-add-button-background-color, --primary-color);
      color: var(--form-data-editor-add-button-color, --primary-background-color);

      @apply(--action-button);
      @apply(--form-data-editor-add-button);
    }

    paper-icon-button {
      color: var(--from-row-action-icon-color, var(--icon-button-color, rgba(0, 0, 0, 0.74)));
      transition: color 0.2s linear;
    }

    paper-icon-button:hover {
      color: var(--from-row-action-icon-color-hover, var(--accent-color, rgba(0, 0, 0, 0.74)));
    }

    .name-field,
    .value-field {
      @apply --layout-flex;
      @apply --layout-horizontal;
      @apply --layout-center;
    }

    .param-name,
    .param-value {
      @apply --layout-flex;
    }

    .narrow .form-row {
      display: block;
    }
    </style>
    <div class="encoder-buttons">
      <paper-button title="Encodes payload to x-www-form-urlencoded data" on-tap="_encodePaylod">encode payload</paper-button>
      <paper-button title="Decodes payload to human readable form" on-tap="_decodePaylod">decode payload</paper-button>
    </div>
    <form is="iron-form" id="form">
      <template is="dom-repeat" items="{{model}}" on-dom-change="_onParamsRender">
        <div class="form-row">
          <form-data-editor-item narrow="[[narrow]]" name="{{item.name}}" value="{{item.value}}" model="[[item.model]]"></form-data-editor-item>
          <span>
            <paper-icon-button icon="arc:close" on-tap="_removeParam"></paper-icon-button>
            <paper-tooltip animation-delay="200">Remove parameter</paper-tooltip>
          </span>
        </div>
      </template>
    </form>
    <paper-button on-tap="add" class="add-param-button">Add form parameter</paper-button>
  </template>
  <script>
  Polymer({
    is: 'form-data-editor',

    behaviors: [
      ArcBehaviors.RequestPayloadEditorBehavior,
      ArcBehaviors.RamlTypeFormBehavior
    ],

    /**
     * Event fire when the value of the editor change.
     * This event is not fired if `attrForOpened` is set and corresponding value is not set.
     *
     * @event payload-value-changed
     * @param {String} value Current payload value.
     */

    properties: {
      /**
       * Generated form model for the value.
       */
      model: Array,
      /**
       * If true it will automatically url-encode value after a change.
       */
      autoEncode: Boolean,
      /**
       * If set it renders a narrow layout
       */
      narrow: {
        type: Boolean,
        value: false
      },
      /**
       * RAML type definition for a body.
       * It adds a documentation and type check from the RAML type.
       */
      ramlType: Object,
      /**
       * The view model generated by the RAML type.
       */
      viewModel: {
        type: Array,
        readOnly: true,
        observer: '_modelFromViewModel'
      }
    },

    get modelOpts() {
      return {
        decodeValues: true
      };
    },

    observers: [
      '_valueChanged(value)',
      '_modelChanged(model.*)',
      '__isOpenedChanged(_isOpened)',
      '_ramlTypeChanged(ramlType)'
    ],

    __isOpenedChanged: function(isOpened) {
      if (isOpened) {
        this.updateModel(this.value);
      }
    },

    _ramlTypeChanged: function(ramlType) {
      if (!ramlType) {
        this._setViewModel(undefined);
        return;
      }
      if (ramlType.formParameters) {
        this._modelFromRaml08(ramlType);
      } else {
        this._modelFromRaml10(ramlType);
      }
    },

    _modelFromRaml10: function(type) {
      if (!type || !type.properties || !type.properties.length) {
        this._setViewModel(undefined);
      }
      var modelOpts = this.modelOpts;
      var model = type.properties.map(function(value) {
        return this._createModelObject(value, modelOpts);
      }, this);
      this._setViewModel(model);
    },

    _modelFromRaml08: function(type) {
      var params = this._clone(type.formParameters);
      var modelOpts = this.modelOpts;
      var model = Object.keys(params).map(function(key) {
        var value = type.formParameters[key];
        value.key = key;
        return this._createModelObject(value, modelOpts);
      }, this);
      this._setViewModel(model);
    },
    /**
     * Handler for value change.
     * If the element is opened then it will update model.
     */
    _valueChanged: function(value) {
      var isOpened = this._isOpened;
      if (this.__internalChange || !isOpened) {
        if (isOpened) {
          this.fire('payload-value-changed', {
            value: value
          });
        }
        return;
      }
      this.updateModel(value);
    },
    /**
     * Updated the `model` from current `value`.
     */
    updateModel: function(value) {
      if (!value) {
        if (this.model && this.viewModel) {
          this.updateValue();
          return;
        }
        return this.set('model', undefined);
      }
      var arr = this.stringToArray(value);
      if (this.autoEncode) {
        arr = this.decodeUrlEncoded(arr);
      }
      this.set('model', arr);
      this._linkModels(arr, this.viewModel);
    },

    _linkModels: function(model, viewModel) {
      if (!viewModel || !model ||!model.length) {
        return;
      }
      this.__stopValueChanged = true;
      var vl = viewModel.length;
      for (var i = 0, len = model.length; i < len; i++) {
        var oldModel = model[i].model;
        var changed = false;
        for (var j = 0; j < vl; j++) {
          if (model[i].name === viewModel[j].name) {
            changed = true;
            if (oldModel !== viewModel[j]) {
              this.set(['model', i, 'model'], viewModel[j]);
            }
            break;
          }
        }
        if (oldModel && !changed) {
          this.set(['model', i, 'model'], undefined);
        }
      }
      this.__stopValueChanged = false;
    },

    /** Encode payload button press handler */
    _encodePaylod: function() {
      if (!this._isOpened) {
        // value is out of sync with model
        return;
      }
      this.encodeValue();
      var arr = this.stringToArray(this.value);
      this.set('model', arr);
    },

    /** Decode payload button press handler */
    _decodePaylod: function() {
      this.decodeValue();
      var arr = this.stringToArray(this.value);
      this.set('model', arr);
    },
    /**
     * Append empty parameter row.
     *
     * @param {?Object} item A predefined values for the model. It adds empty row id no values has
     * been passed.
     */
    add: function(item) {
      item = this._createModelItem(item);
      if (!this.model) {
        this.set('model', [item]);
      } else {
        this.push('model', item);
      }
    },
    // Creates a model item from base object.
    _createModelItem: function(item) {
      item = item || {};
      item.name = item.name || '';
      item.value = item.value || '';
      return this._createModelObject(item, this.modelOpts);
    },

    /**
     * Focuses on the last line of the editor when it renders an item.
     */
    _onParamsRender: function() {
      if (!this.root) {
        return;
      }
      var row = Polymer.dom(this.root).querySelectorAll('.editor .form-row');
      if (!row || !row.length) {
        return;
      }
      row = row.pop();
      try {
        row.children[0].querySelector('input').focus();
      } catch (e) {}
    },

    /** Remove element from the params form */
    _removeParam: function(e) {
      var index = this.$$('template[is="dom-repeat"]').indexForElement(e.target);
      this.splice('model', index, 1);
    },
    // Handler for model change.
    _modelChanged: function(record) {
      if (!record || !record.path || this.__stopValueChanged) {
        return;
      }
      var paths = record.path.split('.');
      var propertyChanged = paths.pop();
      // if path == 'model' it means the object was initialized.
      if (record.path !== 'model') {
        this.updateValue(record.base);
      }
      if (propertyChanged === 'name') {
        var path = paths.join('.');
        this._updateModelWithViewModel(path, record.value);
      }
    },

    _updateModelWithViewModel: function(path, modelName) {
      if (!this.viewModel) {
        return;
      }
      var model = this.viewModel.find(function(item) {
        return item.name === modelName;
      });
      this.set(path + '.model', model);
    },

    _modelFromViewModel: function(viewModel) {
      if (!viewModel) {
        return;
      }
      var model = viewModel.map(function(item) {
        return {
          name: item.name || item.key,
          value: item.value || '',
          model: item
        };
      });
      this.set(['model'], model);
    },
    /**
     * Updates current `value` property from model.
     * If the model attribute is not set it will take current model.
     *
     * @param {?Object<string, string>} model
     */
    updateValue: function(model) {
      if (!this._isOpened) {
        return;
      }
      model = model || this.model;
      var hasModel = model && model.length;
      if (this.autoEncode && hasModel) {
        model = model.map(function(obj) {
          var _obj = Object.assign({}, obj);
          _obj.name = this.encodeQueryString(_obj.name);
          _obj.value = this.encodeQueryString(_obj.value);
          return _obj;
        }, this);
      }
      var value = hasModel ? this.formArrayToString(model) : '';
      this.__internalChange = true;
      this.set('value', value);
      this.__internalChange = false;
    },
    // Computes css class name for narrow layout
    _computeNarrowClass: function(narrow) {
      return narrow ? 'narrow' : undefined;
    }
  });
  </script>
</dom-module>
